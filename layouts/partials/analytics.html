<!-- Site override: analytics partial with Consent Mode defaults at top -->
<!-- Google Consent Mode v2 defaults: set before any Google tags -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied'
  });
  gtag('set', 'ads_data_redaction', true);
  // Optional region-based defaults example:
  // gtag('consent', 'default', { 'ad_storage': 'denied', ... }, { region: ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE','IS','LI','NO','GB'] });
</script>

{{- $config := site.Params }}
<script>
  (function(){
  var analyticsLoaded=false;
  var idleTimeout=6000; // fallback after 6s
  var gaId='{{ with $config.ga_analytics }}{{ . }}{{ end }}';
  var baiduId='{{ with $config.baidu_analytics }}{{ . }}{{ end }}';
  var matomoEnable='{{ if $config.matomo_analytics.enable }}1{{ end }}'==='1';
  var matomoDomain='{{ with $config.matomo_analytics.matomoDomain }}{{ . }}{{ end }}';
  var matomoSiteId='{{ with $config.matomo_analytics.matomoSiteID }}{{ . }}{{ else }}1{{ end }}';
  var plausibleEnable='{{ if $config.plausible_analytics.enable }}1{{ end }}'==='1';
  var plausibleDomain='{{ with $config.plausible_analytics.plausibleDomain }}{{ . }}{{ else }}plausible.io{{ end }}';
  var plausibleSite='{{ with $config.plausible_analytics.websiteDomain }}{{ . }}{{ end }}';
  var plausibleScriptName='{{ with $config.plausible_analytics.scritpName }}{{ . }}{{ else }}plausible{{ end }}';
  var umamiId='{{ with $config.umami_data_website_id }}{{ . }}{{ end }}';
  var umamiUrl='{{ with $config.umami_script_url }}{{ . }}{{ end }}';

    function loadScript(src, async){ var s=document.createElement('script'); s.src=src; if(async!==false) s.async=true; document.head.appendChild(s); return s; }
    function loadGA(){ if(!gaId) return; loadScript('https://www.googletagmanager.com/gtag/js?id='+gaId); window.dataLayer=window.dataLayer||[]; function gtag(){dataLayer.push(arguments);} window.gtag=gtag; gtag('js', new Date()); gtag('config', gaId); }
    function loadBaidu(){ if(!baiduId) return; var hm=document.createElement('script'); hm.src='https://hm.baidu.com/hm.js?'+baiduId; (document.getElementsByTagName('script')[0]||document.head).parentNode.insertBefore(hm, document.getElementsByTagName('script')[0]); }
    function loadMatomo(){ if(!matomoEnable || !matomoDomain) return; var _paq=window._paq=window._paq||[]; _paq.push(['trackPageView']); _paq.push(['enableLinkTracking']); (function(){ var u='//'+matomoDomain+'/'; _paq.push(['setTrackerUrl', u+'matomo.php']); _paq.push(['setSiteId', matomoSiteId]); var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0]; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s); })(); }
    function loadPlausible(){ if(!plausibleEnable || !plausibleSite) return; var s=document.createElement('script'); s.setAttribute('data-domain', plausibleSite); s.defer=true; s.src='https://'+plausibleDomain+'/js/'+plausibleScriptName+'.js'; document.head.appendChild(s); }
    function loadUmami(){ if(!umamiId || !umamiUrl) return; var s=document.createElement('script'); s.defer=true; s.src=umamiUrl; s.setAttribute('data-website-id', umamiId); document.head.appendChild(s); }
    function loadAll(){ if(analyticsLoaded) return; analyticsLoaded=true; loadGA(); loadBaidu(); loadMatomo(); loadPlausible(); loadUmami(); }
    ['click','keydown','pointerdown','scroll','touchstart','visibilitychange'].forEach(function(evt){ window.addEventListener(evt,function(){ if(evt==='visibilitychange' && document.visibilityState!=='visible') return; loadAll(); }, { once:true, passive:true }); });
    if('requestIdleCallback' in window){ requestIdleCallback(function(){ loadAll(); }, { timeout: idleTimeout }); } else { setTimeout(loadAll, idleTimeout+1000); }
    window.__loadAnalyticsNow = loadAll;
  })();
</script>

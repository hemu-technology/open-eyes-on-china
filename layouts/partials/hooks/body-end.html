{{/* Site-level body-end hook: search keyboard navigation without touching theme files */}}
<script>
(function(){
  if(!document.querySelector) return;
  var input = document.getElementById('find');
  if(!input) return;
  function bySel(s,ctx){return (ctx||document).querySelector(s);}  
  function allSel(s,ctx){return Array.prototype.slice.call((ctx||document).querySelectorAll(s));}

  // Enhance input for combobox pattern
  input.setAttribute('role','combobox');
  input.setAttribute('aria-autocomplete','list');
  input.setAttribute('aria-expanded','false');

  // Remove default "Results" / placeholder title nodes as soon as they appear
  function scrubResultsContainer(){
    var container = bySel('.search_results');
    if(!container) return;
    Array.prototype.slice.call(container.children).forEach(function(n){
      if(!n) return;
      var isTitle = n.classList && n.classList.contains('search_title');
      var isNonAnchorResult = n.classList && n.classList.contains('search_result') && n.tagName !== 'A';
      if(isTitle || isNonAnchorResult){
        n.parentNode && n.parentNode.removeChild(n);
      }
    });
  }
  var resultsNode = bySel('.search_results');
  if(resultsNode){
    var mo = new MutationObserver(function(){ scrubResultsContainer(); });
    mo.observe(resultsNode, {childList:true});
  }

  input.addEventListener('keydown', function(e){
    var resultsContainer = bySel('.search_results');
    if(!resultsContainer) return;
    // Collect only actual result links (anchors), ignore placeholder label/span nodes
    var rawItems = allSel('.search_result', resultsContainer);
    var items = rawItems.filter(function(el){ return el.tagName === 'A'; });
    // Optional: once user starts navigating, remove placeholder nodes to avoid duplicate selection feel
    if((e.key === 'ArrowDown' || e.key === 'ArrowUp') && items.length && rawItems.length !== items.length){
      rawItems.forEach(function(el){ if(el.tagName !== 'A'){ el.parentNode && el.parentNode.removeChild(el); }});
    }
    if(!items.length){
      input.setAttribute('aria-activedescendant','');
      input.setAttribute('aria-expanded','false');
      return;
    }
    input.setAttribute('aria-expanded','true');
    var ACTIVE = 'search_result--active';
    // ARIA roles (lazy apply once)
    if(!resultsContainer.getAttribute('role')){
      resultsContainer.setAttribute('role','listbox');
      items.forEach(function(it,i){
        it.setAttribute('role','option');
        if(!it.id) it.id = 'search-option-' + i;
        // Remove any tabindex to keep focus on input
        if(it.hasAttribute('tabindex')) it.removeAttribute('tabindex');
      });
    }
    function currentIndex(){
      for(var i=0;i<items.length;i++){ if(items[i].classList.contains(ACTIVE)) return i; }
      return -1;
    }
    var idx = currentIndex();
    if(e.key === 'ArrowDown'){
      e.preventDefault();
      // If nothing selected yet, start at first (0) instead of skipping to second
      if(idx === -1){ idx = 0; } else { idx = (idx + 1) % items.length; }
    } else if(e.key === 'ArrowUp') {
      e.preventDefault();
      // If nothing selected yet, start at last item
      if(idx === -1){ idx = items.length - 1; } else { idx = (idx - 1 + items.length) % items.length; }
    } else if(e.key === 'Enter') {
      var active = bySel('.'+ACTIVE, resultsContainer) || items[0];
      if(active && active.href){
        // Prevent theme's default handler from redirecting to the search page
        e.preventDefault();
        e.stopPropagation();
        window.location.href = active.href;
      }
      return;
    } else if(e.key === 'Escape') {
      items.forEach(function(it){ it.classList.remove(ACTIVE); });
      input.setAttribute('aria-activedescendant','');
      input.setAttribute('aria-expanded','false');
      return; // allow other escape handlers
    } else {
      return; // ignore other keys
    }
    items.forEach(function(it){ it.classList.remove(ACTIVE); });
    var choice = items[idx];
    if(choice){
      choice.classList.add(ACTIVE);
      input.setAttribute('aria-activedescendant', choice.id);
      // Keep focus on input to avoid page scroll; optionally ensure active item visibility
      if(typeof choice.scrollIntoView === 'function'){
        // Only scroll if item is partially out of view to minimize jumpiness
        var rect = choice.getBoundingClientRect();
        if(rect.top < 0 || rect.bottom > (window.innerHeight||document.documentElement.clientHeight)){
          choice.scrollIntoView({block:'nearest'});
        }
      }
    }
  });

  // Intercept the native 'search' event (fired by some browsers on Enter or clear)
  // Use capture phase so we run before the theme's listener that navigates to the search page.
  input.addEventListener('search', function(e){
    var resultsContainer = bySel('.search_results');
    if(!resultsContainer) return;
    var active = bySel('.search_result--active', resultsContainer);
    var first = bySel('.search_result', resultsContainer);
    var target = active && active.tagName === 'A' ? active : (first && first.tagName === 'A' ? first : null);
    if(target && target.href){
      e.preventDefault();
      e.stopPropagation();
      window.location.href = target.href;
    }
  }, true);
})();
</script>

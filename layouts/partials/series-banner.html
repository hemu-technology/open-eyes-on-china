{{/* Compact top-of-article series navigation banner. */}}
{{ with .Params.series }}
  {{ $name := index . 0 }}
  {{ $raw := where $.Site.RegularPages "Params.series" "intersect" (slice $name) }}
  {{ $items := sort $raw "Date" }}
  {{ $count := len $items }}
  {{ if gt $count 1 }}
    {{ $currentIndex := 0 }}
    {{ range $i, $p := $items }}
      {{ if eq $p.Permalink $.Permalink }}{{ $currentIndex = add $i 1 }}{{ end }}
    {{ end }}
    {{/* Determine if banner should default open (not first part) */}}
    {{ $openAttr := "" }}
    {{ if gt $currentIndex 1 }}{{ $openAttr = "open" }}{{ end }}
  <details class="series-banner" data-series="{{ $name | urlize }}" {{ $openAttr }}>
      <summary class="series-banner__summary">
        <span class="series-banner__label">Series:</span>
        <span class="series-banner__name">{{ $name }}</span>
        <span class="series-banner__part">Part {{ $currentIndex }} of {{ $count }}</span>
        <span class="series-banner__toggle-text">Show all parts ▸</span>
      </summary>
      {{/* Progress bar */}}
      {{ $pct := mul (div (float $currentIndex) (float $count)) 100.0 }}
      {{ $pctStr := printf "%.2f" $pct }}
      <div aria-hidden="true" class="series-progress">
        <div class="series-progress__bar" data-progress="{{ $pctStr }}"></div>
      </div>
      <div class="series-banner__nav">
        <div class="series-banner__parts">
          {{ range $i, $p := $items }}
            {{ $n := add $i 1 }}
            {{ if eq $p.Permalink $.Permalink }}
              <span class="series-banner__part-link is-current">{{ $n }}</span>
            {{ else }}
              <a href="{{ $p.RelPermalink }}" class="series-banner__part-link">{{ $n }}</a>
            {{ end }}
          {{ end }}
        </div>
        <div class="series-banner__prevnext">
          {{ if gt $currentIndex 1 }}
            {{ $prev := index $items (sub $currentIndex 2) }}
            <a href="{{ $prev.RelPermalink }}" class="series-banner__prev">← Prev</a>
          {{ end }}
          {{ if lt $currentIndex $count }}
            {{ $next := index $items $currentIndex }}
            <a href="{{ $next.RelPermalink }}" class="series-banner__next">Next →</a>
          {{ end }}
        </div>
      </div>
    </details>
    <script>
      (function(){
        var d=document,current=location.pathname;
        var wrapper=d.querySelector('.series-banner');
        if(!wrapper) return;
        var summary=wrapper.querySelector('summary');
        var label=summary && summary.querySelector('span:last-child');
        var seriesId=wrapper.getAttribute('data-series')||'generic';
        var storageKey='seriesBannerState:'+seriesId;
        function setLabel(open){ if(label) label.textContent=open?'Hide parts ▾':'Show all parts ▸'; }
        var saved=localStorage.getItem(storageKey);
        if(saved==='open') { wrapper.setAttribute('open','open'); }
        else if(saved==='closed'){ wrapper.removeAttribute('open'); }
        setLabel(wrapper.open);
        wrapper.addEventListener('toggle',function(){
          setLabel(wrapper.open);
          try{ localStorage.setItem(storageKey, wrapper.open?'open':'closed'); }catch(e){}
        });
        // Apply progress width
        var prog=wrapper.querySelector('[data-progress]');
        if(prog){ var val=prog.getAttribute('data-progress'); if(val){ prog.style.width=val+'%'; }}
      })();
    </script>
  {{ end }}
{{ end }}

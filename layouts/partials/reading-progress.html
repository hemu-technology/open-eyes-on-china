{{/* Top reading progress bar spanning full viewport width. */}}
{{- $s := site.Params -}}
{{- if and $s.enableReadingProgress (eq (default "sidebar" $s.readingProgressMode) "top") -}}
  {{- $offset := default 0 $s.readingProgressOffset -}}
  <style>
    #top-reading-progress{position:fixed;top:0;left:0;height:5px;z-index:2147483000;background:rgba(0,0,0,0.08);pointer-events:none;}
    #top-reading-progress.debug{outline:1px dashed red;}
    #top-reading-progress-fill{height:100%;background:linear-gradient(90deg,#3b82f6,#2563eb);transition:width .15s linear;width:0%;}
  </style>
  <div id="top-reading-progress" data-offset="{{ $offset }}" data-width-mode="full">
    <div id="top-reading-progress-fill"></div>
  </div>
  <script>
    (function(){
      function init(){
        var bar=document.getElementById('top-reading-progress');
        var fill=document.getElementById('top-reading-progress-fill');
        if(!bar||!fill) return;
        var article=document.querySelector('.post_content .post_body');
        if(!article){ bar.style.display='none'; return; }
        // Move bar to body end to avoid clipping by parent stacking contexts
        if(bar.parentNode !== document.body){ document.body.appendChild(bar); }
        var offset=parseInt(bar.getAttribute('data-offset')||'0',10)||0;
        function applyOffset(){ bar.style.top = offset + 'px'; bar.style.left='0'; bar.style.width='100%'; }
        function clamp(v){ return v<0?0:v>100?100:v; }
        function updateProgress(){
          var total=article.scrollHeight - window.innerHeight;
          if(total<0) total=article.scrollHeight;
            var scrolled=window.scrollY - article.offsetTop;
          if(scrolled<0) scrolled=0;
          var pct= total>0 ? (scrolled/total)*100 : ((window.scrollY>0)?100:0);
          pct = clamp(pct);
          fill.style.width=pct+'%';
        }
        var ticking=false;
        function frame(){ updateProgress(); }
        function schedule(){ if(!ticking){ ticking=true; requestAnimationFrame(function(){ frame(); ticking=false; }); }}
        window.addEventListener('scroll', schedule, {passive:true});
        window.addEventListener('resize', schedule);
        window.addEventListener('orientationchange', schedule);
        applyOffset();
        frame();
        // Debug auto-enable if no width change after short delay
        setTimeout(function(){
          if(fill.style.width==='0%'){
            // bar.classList.add('debug'); // uncomment to visualize bar area
          }
        },600);
      }
      if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }
    })();
  </script>
{{- end -}}

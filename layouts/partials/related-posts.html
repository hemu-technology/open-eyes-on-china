{{/* Related posts (non-series). Exclude current page and any in same series already displayed */}}
{{- $page := . -}}
{{- if not .Params.disableRelated }}
  {{- $related := .Site.RegularPages.Related . | first 6 -}}
  {{- if not (gt (len $related) 0) -}}
    {{/* Fallback: manual similarity by tags then categories */}}
    {{- $tags := slice }}
    {{- with .Params.tags }}{{ $tags = . }}{{ end }}
    {{- if gt (len $tags) 0 }}
      {{- $related = where (where .Site.RegularPages "Permalink" "ne" .Permalink) "Params.tags" "intersect" $tags | first 6 -}}
    {{- end }}
    {{- if and (eq (len $related) 0) (isset .Params "categories") }}
      {{- $related = where (where .Site.RegularPages "Permalink" "ne" .Permalink) "Params.categories" "intersect" .Params.categories | first 6 -}}
    {{- end }}
  {{- end }}
  {{- if gt (len $related) 0 }}
  <section class="related-posts">
    <h2>Related Posts</h2>
    <ul class="related-posts-list" style="list-style:none; padding-left:0; margin:0; display:grid; gap:1rem; grid-template-columns:repeat(auto-fill,minmax(240px,1fr));">
      {{- range $related }}
        <li style="border:1px solid #eee; border-radius:8px; background:#fff; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.05); padding:0;">
          <a href="{{ .RelPermalink }}" title="{{ .Title }}" style="text-decoration:none; color:inherit; display:block;">
            {{ with .Params.thumbnail }}<img src="/{{ . }}" alt="" loading="lazy" style="width:100%; height:140px; object-fit:cover; display:block; margin:0;" />{{ end }}
            <div style="padding:.75rem .85rem 1rem .85rem;">
              <div style="font-weight:600; font-size:1rem; line-height:1.3; margin-bottom:.45rem; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis; min-height:2.6em;" title="{{ .Title }}">{{ .Title }}</div>
              <div style="font-size:.8rem; color:#777; display:flex; gap:.6rem; flex-wrap:wrap;">
                <span>{{ .Date.Format "Jan 2, 2006" }}</span>
                {{ with .Params.tags }}
                  {{ $limited := (first 2 .) }}
                  <span>{{ delimit $limited ", " }}</span>
                {{ end }}
              </div>
            </div>
          </a>
        </li>
      {{- end }}
    </ul>
  </section>
  {{- end }}
{{- end }}
